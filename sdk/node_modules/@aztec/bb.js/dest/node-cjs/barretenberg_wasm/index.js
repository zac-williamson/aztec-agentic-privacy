"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.fetchModuleAndThreads = fetchModuleAndThreads;
const index_js_1 = require("./helpers/node/index.js");
const index_js_2 = require("./fetch_code/index.js");
async function fetchModuleAndThreads(desiredThreads = 32, wasmPath, logger = () => { }) {
    const shared = (0, index_js_1.getSharedMemoryAvailable)();
    const availableThreads = shared ? await (0, index_js_1.getAvailableThreads)(logger) : 1;
    // We limit the number of threads to 32 as we do not benefit from greater numbers.
    const limitedThreads = Math.min(desiredThreads, availableThreads, 32);
    logger(`Fetching bb wasm from ${wasmPath ?? 'default location'}`);
    const code = await (0, index_js_2.fetchCode)(shared, wasmPath);
    logger(`Compiling bb wasm of ${code.byteLength} bytes`);
    const module = await WebAssembly.compile(code);
    logger('Compilation of bb wasm complete');
    return { module, threads: limitedThreads };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYmFycmV0ZW5iZXJnX3dhc20vaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsc0RBQXdGO0FBQ3hGLG9EQUFrRDtBQUUzQyxLQUFLLGdDQUNWLGNBQWMsR0FBRyxFQUFFLEVBQ25CLFFBQWlCLEVBQ2pCLE1BQU0sR0FBMEIsR0FBRyxFQUFFLENBQUMsRUFBQyxDQUFDLEVBQ3hDO0lBQ0EsTUFBTSxNQUFNLEdBQUcsSUFBQSxtQ0FBd0IsR0FBRSxDQUFDO0lBRTFDLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLElBQUEsOEJBQW1CLEVBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN4RSxrRkFBa0Y7SUFDbEYsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFdEUsTUFBTSxDQUFDLHlCQUF5QixRQUFRLElBQUksa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBQ2xFLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBQSxvQkFBUyxFQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztJQUMvQyxNQUFNLENBQUMsd0JBQXdCLElBQUksQ0FBQyxVQUFVLFFBQVEsQ0FBQyxDQUFDO0lBQ3hELE1BQU0sTUFBTSxHQUFHLE1BQU0sV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQyxNQUFNLENBQUMsaUNBQWlDLENBQUMsQ0FBQztJQUMxQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsQ0FBQztBQUFBLENBQzVDIn0=