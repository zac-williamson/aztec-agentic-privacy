"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BarretenbergWasmAsyncBackend = exports.BarretenbergWasmSyncBackend = void 0;
const index_js_1 = require("../barretenberg_wasm/barretenberg_wasm_main/index.js");
const index_js_2 = require("../barretenberg_wasm/index.js");
const index_js_3 = require("../barretenberg_wasm/barretenberg_wasm_main/factory/node/index.js");
const index_js_4 = require("../barretenberg_wasm/helpers/index.js");
const comlink_1 = require("comlink");
/**
 * Synchronous WASM backend that wraps BarretenbergWasmMain.
 * Encapsulates all WASM initialization and memory management.
 */
class BarretenbergWasmSyncBackend {
    wasm;
    constructor(wasm) {
        this.wasm = wasm;
    }
    /**
     * Create and initialize a synchronous WASM backend.
     * @param wasmPath Optional path to WASM files
     * @param logger Optional logging function
     */
    static async new(wasmPath, logger) {
        const wasm = new index_js_1.BarretenbergWasmMain();
        const { module, threads } = await (0, index_js_2.fetchModuleAndThreads)(1, wasmPath, logger);
        await wasm.init(module, threads, logger);
        return new BarretenbergWasmSyncBackend(wasm);
    }
    call(inputBuffer) {
        return this.wasm.cbindCall('bbapi', inputBuffer);
    }
    destroy() {
        // BarretenbergWasmMain has async destroy, but for sync API we call it without awaiting
        // This is consistent with the synchronous semantics expected by the caller
        void this.wasm.destroy();
    }
}
exports.BarretenbergWasmSyncBackend = BarretenbergWasmSyncBackend;
/**
 * Asynchronous WASM backend that supports both direct WASM and worker-based modes.
 *
 * Worker mode (default): Runs WASM on a worker thread to avoid blocking the main thread. Used in browsers.
 * Direct mode: Runs WASM directly on the calling thread. Used by node.js for better performance.
 */
class BarretenbergWasmAsyncBackend {
    wasm;
    worker;
    constructor(wasm, worker) {
        this.wasm = wasm;
        this.worker = worker;
    }
    /**
     * Create and initialize an asynchronous WASM backend.
     * @param options.threads Number of threads (defaults to hardware max, up to 32 for parallel proving)
     * @param options.wasmPath Optional path to WASM files
     * @param options.logger Optional logging function
     * @param options.memory Optional initial and maximum memory configuration
     * @param options.useWorker Run on worker thread (default: true for browser safety)
     */
    static async new(options = {}) {
        // Default to worker mode for browser safety
        const useWorker = options.useWorker ?? true;
        if (useWorker) {
            // Worker-based mode: runs on worker thread (browser-safe)
            const worker = await (0, index_js_3.createMainWorker)();
            const wasm = (0, index_js_4.getRemoteBarretenbergWasm)(worker);
            const { module, threads } = await (0, index_js_2.fetchModuleAndThreads)(options.threads, options.wasmPath, options.logger);
            await wasm.init(module, threads, (0, comlink_1.proxy)(options.logger ?? (() => { })), options.memory?.initial, options.memory?.maximum);
            return new BarretenbergWasmAsyncBackend(wasm, worker);
        }
        else {
            // Direct mode: runs on calling thread (faster but blocks thread)
            const wasm = new index_js_1.BarretenbergWasmMain();
            const { module, threads } = await (0, index_js_2.fetchModuleAndThreads)(options.threads, options.wasmPath, options.logger);
            await wasm.init(module, threads, options.logger, options.memory?.initial, options.memory?.maximum);
            return new BarretenbergWasmAsyncBackend(wasm);
        }
    }
    async call(inputBuffer) {
        return this.wasm.cbindCall('bbapi', inputBuffer);
    }
    async destroy() {
        await this.wasm.destroy();
        if (this.worker) {
            await this.worker.terminate();
        }
    }
}
exports.BarretenbergWasmAsyncBackend = BarretenbergWasmAsyncBackend;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2FzbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9iYl9iYWNrZW5kcy93YXNtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1GQUF3SDtBQUN4SCw0REFBc0U7QUFFdEUsZ0dBQXFHO0FBQ3JHLG9FQUFrRjtBQUNsRixxQ0FBZ0M7QUFFaEM7OztHQUdHO0FBQ0g7SUFDOEIsSUFBSTtJQUFoQyxZQUE0QixJQUEwQixFQUFFO29CQUE1QixJQUFJO0lBQXlCLENBQUM7SUFFMUQ7Ozs7T0FJRztJQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQWlCLEVBQUUsTUFBOEIsRUFBd0M7UUFDeEcsTUFBTSxJQUFJLEdBQUcsSUFBSSwrQkFBb0IsRUFBRSxDQUFDO1FBQ3hDLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsTUFBTSxJQUFBLGdDQUFxQixFQUFDLENBQUMsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDN0UsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDekMsT0FBTyxJQUFJLDJCQUEyQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQUEsQ0FDOUM7SUFFRCxJQUFJLENBQUMsV0FBdUIsRUFBYztRQUN4QyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQztJQUFBLENBQ2xEO0lBRUQsT0FBTyxHQUFTO1FBQ2QsdUZBQXVGO1FBQ3ZGLDJFQUEyRTtRQUMzRSxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFBQSxDQUMxQjtDQUNGOztBQUVEOzs7OztHQUtHO0FBQ0g7SUFFWSxJQUFJO0lBQ0osTUFBTTtJQUZoQixZQUNVLElBQXVELEVBQ3ZELE1BQVksRUFDcEI7b0JBRlEsSUFBSTtzQkFDSixNQUFNO0lBQ2IsQ0FBQztJQUVKOzs7Ozs7O09BT0c7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FDZCxPQUFPLEdBTUgsRUFBRSxFQUNpQztRQUN2Qyw0Q0FBNEM7UUFDNUMsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUM7UUFFNUMsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUNkLDBEQUEwRDtZQUMxRCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsMkJBQWdCLEdBQUUsQ0FBQztZQUN4QyxNQUFNLElBQUksR0FBRyxJQUFBLG9DQUF5QixFQUE2QixNQUFNLENBQUMsQ0FBQztZQUMzRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLE1BQU0sSUFBQSxnQ0FBcUIsRUFBQyxPQUFPLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzNHLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FDYixNQUFNLEVBQ04sT0FBTyxFQUNQLElBQUEsZUFBSyxFQUFDLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFDLEVBQ25DLE9BQU8sQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUN2QixPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FDeEIsQ0FBQztZQUNGLE9BQU8sSUFBSSw0QkFBNEIsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDeEQsQ0FBQzthQUFNLENBQUM7WUFDTixpRUFBaUU7WUFDakUsTUFBTSxJQUFJLEdBQUcsSUFBSSwrQkFBb0IsRUFBRSxDQUFDO1lBQ3hDLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsTUFBTSxJQUFBLGdDQUFxQixFQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDM0csTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ25HLE9BQU8sSUFBSSw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoRCxDQUFDO0lBQUEsQ0FDRjtJQUVELEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBdUIsRUFBdUI7UUFDdkQsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFBQSxDQUNsRDtJQUVELEtBQUssQ0FBQyxPQUFPLEdBQWtCO1FBQzdCLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMxQixJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNoQixNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDaEMsQ0FBQztJQUFBLENBQ0Y7Q0FDRiJ9