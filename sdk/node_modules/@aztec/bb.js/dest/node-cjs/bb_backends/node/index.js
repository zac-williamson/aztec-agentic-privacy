"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createAsyncBackend = createAsyncBackend;
exports.createSyncBackend = createSyncBackend;
const native_socket_js_1 = require("./native_socket.js");
const wasm_js_1 = require("../wasm.js");
const native_shm_js_1 = require("./native_shm.js");
const native_shm_async_js_1 = require("./native_shm_async.js");
const platform_js_1 = require("./platform.js");
const index_js_1 = require("../../barretenberg/index.js");
const index_js_2 = require("../index.js");
/**
 * Create backend of specific type (no fallback)
 */
async function createAsyncBackend(type, options, logger) {
    options = {
        ...options,
        wasmPath: options.wasmPath ?? process.env.BB_WASM_PATH,
    };
    switch (type) {
        case index_js_2.BackendType.NativeUnixSocket: {
            const bbPath = (0, platform_js_1.findBbBinary)(options.bbPath);
            if (!bbPath) {
                throw new Error('Native backend requires bb binary.');
            }
            logger(`Using native Unix socket backend: ${bbPath}`);
            const socket = new native_socket_js_1.BarretenbergNativeSocketAsyncBackend(bbPath, options.threads, options.logger);
            return new index_js_1.Barretenberg(socket, options);
        }
        case index_js_2.BackendType.NativeSharedMemory: {
            const bbPath = (0, platform_js_1.findBbBinary)(options.bbPath);
            if (!bbPath) {
                throw new Error('Native backend requires bb binary.');
            }
            const napiPath = (0, platform_js_1.findNapiBinary)(options.napiPath);
            if (!napiPath) {
                throw new Error('Native async backend requires napi client stub.');
            }
            logger(`Using native shared memory async backend: ${bbPath}`);
            const asyncBackend = await native_shm_async_js_1.BarretenbergNativeShmAsyncBackend.new(bbPath, napiPath, options.threads, options.logger);
            return new index_js_1.Barretenberg(asyncBackend, options);
        }
        case index_js_2.BackendType.Wasm:
        case index_js_2.BackendType.WasmWorker: {
            const useWorker = type === index_js_2.BackendType.WasmWorker;
            logger(`Using WASM backend (worker: ${useWorker})`);
            const wasm = await wasm_js_1.BarretenbergWasmAsyncBackend.new({
                threads: options.threads,
                wasmPath: options.wasmPath,
                logger: options.logger,
                memory: options.memory,
                useWorker,
            });
            return new index_js_1.Barretenberg(wasm, options);
        }
        default:
            throw new Error(`Unknown backend type: ${type}`);
    }
}
/**
 * Create backend of specific type (no fallback)
 */
async function createSyncBackend(type, options, logger) {
    options = {
        ...options,
        wasmPath: options.wasmPath ?? process.env.BB_WASM_PATH,
    };
    switch (type) {
        case index_js_2.BackendType.NativeSharedMemory: {
            const bbPath = (0, platform_js_1.findBbBinary)(options.bbPath);
            if (!bbPath) {
                throw new Error('Native backend requires bb binary.');
            }
            const napiPath = (0, platform_js_1.findNapiBinary)(options.napiPath);
            if (!napiPath) {
                throw new Error('Native sync backend requires napi client stub.');
            }
            logger(`Using native shared memory backend: ${bbPath}`);
            const shm = await native_shm_js_1.BarretenbergNativeShmSyncBackend.new(bbPath, napiPath, options.threads, options.logger);
            return new index_js_1.BarretenbergSync(shm);
        }
        case index_js_2.BackendType.Wasm:
            logger('Using WASM backend');
            const wasm = await wasm_js_1.BarretenbergWasmSyncBackend.new(options.wasmPath, logger);
            return new index_js_1.BarretenbergSync(wasm);
        default:
            throw new Error(`Backend ${type} not supported for BarretenbergSync`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYmJfYmFja2VuZHMvbm9kZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEseURBQTBFO0FBQzFFLHdDQUF1RjtBQUN2RixtREFBbUU7QUFDbkUsK0RBQTBFO0FBQzFFLCtDQUE2RDtBQUM3RCwwREFBNkU7QUFDN0UsMENBQTBEO0FBRTFEOztHQUVHO0FBQ0ksS0FBSyw2QkFDVixJQUFpQixFQUNqQixPQUF1QixFQUN2QixNQUE2QixFQUNOO0lBQ3ZCLE9BQU8sR0FBRztRQUNSLEdBQUcsT0FBTztRQUNWLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWTtLQUN2RCxDQUFDO0lBRUYsUUFBUSxJQUFJLEVBQUUsQ0FBQztRQUNiLEtBQUssc0JBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ2xDLE1BQU0sTUFBTSxHQUFHLElBQUEsMEJBQVksRUFBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDNUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQztZQUN4RCxDQUFDO1lBQ0QsTUFBTSxDQUFDLHFDQUFxQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBQ3RELE1BQU0sTUFBTSxHQUFHLElBQUksdURBQW9DLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2pHLE9BQU8sSUFBSSx1QkFBWSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMzQyxDQUFDO1FBRUQsS0FBSyxzQkFBVyxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDcEMsTUFBTSxNQUFNLEdBQUcsSUFBQSwwQkFBWSxFQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUM1QyxJ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