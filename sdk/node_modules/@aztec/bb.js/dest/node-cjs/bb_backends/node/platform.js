"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
exports.findPackageRoot = findPackageRoot;
exports.detectPlatform = detectPlatform;
exports.findBbBinary = findBbBinary;
exports.findNapiBinary = findNapiBinary;
const path = tslib_1.__importStar(require("path"));
const fs = tslib_1.__importStar(require("fs"));
const url_1 = require("url");
function getCurrentDir() {
    if (typeof __dirname !== 'undefined') {
        return __dirname;
    }
    else {
        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
        // @ts-ignore
        return path.dirname((0, url_1.fileURLToPath)(""));
    }
}
/**
 * Find package root by climbing directory tree until package.json is found.
 * @param startDir Starting directory to search from
 * @returns Absolute path to package root, or null if not found
 */
function findPackageRoot() {
    let currentDir = getCurrentDir();
    const root = path.parse(currentDir).root;
    while (currentDir !== root) {
        const packageJsonPath = path.join(currentDir, 'package.json');
        if (fs.existsSync(packageJsonPath)) {
            // Check if this is the actual package root by verifying it has a 'build' directory
            // This ensures we skip intermediate package.json files (e.g., in dest/node-cjs/)
            const buildDir = path.join(currentDir, 'build');
            if (fs.existsSync(buildDir)) {
                return currentDir;
            }
        }
        currentDir = path.dirname(currentDir);
    }
    return null;
}
/**
 * Map from Platform to build directory name.
 */
const PLATFORM_TO_BUILD_DIR = {
    'x86_64-linux': 'amd64-linux',
    'x86_64-darwin': 'amd64-macos',
    'aarch64-linux': 'arm64-linux',
    'aarch64-darwin': 'arm64-macos',
};
/**
 * Detect the current platform and architecture.
 * @returns Platform identifier or null if unsupported
 */
function detectPlatform() {
    const arch = process.arch; // 'x64' | 'arm64' | ...
    const platform = process.platform; // 'linux' | 'darwin' | 'win32' | ...
    if (arch === 'x64' && platform === 'linux') {
        return 'x86_64-linux';
    }
    if (arch === 'x64' && platform === 'darwin') {
        return 'x86_64-darwin';
    }
    if (arch === 'arm64' && platform === 'linux') {
        return 'aarch64-linux';
    }
    if (arch === 'arm64' && platform === 'darwin') {
        return 'aarch64-darwin';
    }
    return null;
}
/**
 * Find the bb binary for the native backend.
 * @param customPath Optional custom path to bb binary (overrides automatic detection)
 * @returns Absolute path to bb binary, or null if not found
 *
 * Search order:
 * 1. If customPath is provided and exists, return it
 * 2. Otherwise search in <package-root>/build/<platform>/bb
 */
function findBbBinary(customPath) {
    // Check custom path first if provided
    if (customPath) {
        if (fs.existsSync(customPath)) {
            return path.resolve(customPath);
        }
        // Custom path provided but doesn't exist - return null
        return null;
    }
    // Automatic detection
    const platform = detectPlatform();
    if (!platform) {
        return null;
    }
    const buildDir = PLATFORM_TO_BUILD_DIR[platform];
    // Get package root by climbing directory tree to find package.json
    const packageRoot = findPackageRoot();
    if (!packageRoot) {
        return null;
    }
    // Check in build/<platform>/bb
    const bbPath = path.join(packageRoot, 'build', buildDir, 'bb');
    if (fs.existsSync(bbPath)) {
        return bbPath;
    }
    return null;
}
function findNapiBinary(customPath) {
    // Check custom path first if provided
    if (customPath) {
        if (fs.existsSync(customPath)) {
            return path.resolve(customPath);
        }
        // Custom path provided but doesn't exist - return null
        return null;
    }
    // Automatic detection
    const platform = detectPlatform();
    if (!platform) {
        return null;
    }
    const buildDir = PLATFORM_TO_BUILD_DIR[platform];
    // Get package root by climbing directory tree to find package.json
    const packageRoot = findPackageRoot();
    if (!packageRoot) {
        return null;
    }
    // Check in build/<platform>/nodejs_module.node
    const bbPath = path.join(packageRoot, 'build', buildDir, 'nodejs_module.node');
    if (fs.existsSync(bbPath)) {
        return bbPath;
    }
    return null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxhdGZvcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYmJfYmFja2VuZHMvbm9kZS9wbGF0Zm9ybS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUEsTUFBWSxJQUFJLHlDQUFhO0FBQzdCLE1BQVksRUFBRSx1Q0FBVztBQUN6Qiw2QkFBb0M7QUFFcEMsU0FBUyxhQUFhLEdBQUc7SUFDdkIsSUFBSSxPQUFPLFNBQVMsS0FBSyxXQUFXLEVBQUUsQ0FBQztRQUNyQyxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO1NBQU0sQ0FBQztRQUNOLDZEQUE2RDtRQUM3RCxhQUFhO1FBQ2IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUEsbUJBQWEsRUFBQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3RELENBQUM7QUFBQSxDQUNGO0FBRUQ7Ozs7R0FJRztBQUNILDJCQUFpRDtJQUMvQyxJQUFJLFVBQVUsR0FBRyxhQUFhLEVBQUUsQ0FBQztJQUNqQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUV6QyxPQUFPLFVBQVUsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUMzQixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUM5RCxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQztZQUNuQyxtRkFBbUY7WUFDbkYsaUZBQWlGO1lBQ2pGLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2hELElBQUksRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUM1QixPQUFPLFVBQVUsQ0FBQztZQUNwQixDQUFDO1FBQ0gsQ0FBQztRQUNELFVBQVUs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