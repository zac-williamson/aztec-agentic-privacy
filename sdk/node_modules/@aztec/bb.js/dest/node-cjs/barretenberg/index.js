"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BarretenbergSync = exports.Barretenberg = exports.fieldsToStrings = exports.fieldToString = exports.AztecClientBackend = exports.UltraHonkVerifierBackend = exports.UltraHonkBackend = void 0;
const tslib_1 = require("tslib");
const index_js_1 = require("../crs/index.js");
const async_js_1 = require("../cbind/generated/async.js");
const sync_js_1 = require("../cbind/generated/sync.js");
const index_js_2 = require("../bb_backends/index.js");
const index_js_3 = require("../bb_backends/node/index.js");
const backend_js_1 = require("./backend.js");
Object.defineProperty(exports, "UltraHonkBackend", { enumerable: true, get: function () { return backend_js_1.UltraHonkBackend; } });
Object.defineProperty(exports, "UltraHonkVerifierBackend", { enumerable: true, get: function () { return backend_js_1.UltraHonkVerifierBackend; } });
Object.defineProperty(exports, "AztecClientBackend", { enumerable: true, get: function () { return backend_js_1.AztecClientBackend; } });
Object.defineProperty(exports, "fieldToString", { enumerable: true, get: function () { return backend_js_1.fieldToString; } });
Object.defineProperty(exports, "fieldsToStrings", { enumerable: true, get: function () { return backend_js_1.fieldsToStrings; } });
tslib_1.__exportStar(require("../bb_backends/index.js"), exports);
/**
 * The main class library consumers interact with.
 * It extends the generated api, and provides a static constructor "new" to compose components.
 */
class Barretenberg extends async_js_1.AsyncApi {
    options;
    constructor(backend, options) {
        super(backend);
        this.options = options;
    }
    /**
     * Constructs an instance of Barretenberg.
     *
     * If options.backend is set: uses that specific backend (throws if unavailable)
     * If options.backend is unset: tries backends in order with fallback:
     *   1. NativeUnixSocket (if bb binary available)
     *   2. WasmWorker (in browser) or Wasm (in Node.js)
     */
    static async new(options = {}) {
        const logger = options.logger ?? (() => { });
        if (options.backend) {
            // Explicit backend required - no fallback
            const backend = await (0, index_js_3.createAsyncBackend)(options.backend, options, logger);
            if (options.backend === index_js_2.BackendType.Wasm || options.backend === index_js_2.BackendType.WasmWorker) {
                await backend.initSRSChonk();
            }
            return backend;
        }
        if (typeof window === 'undefined') {
            try {
                return await (0, index_js_3.createAsyncBackend)(index_js_2.BackendType.NativeUnixSocket, options, logger);
            }
            catch (err) {
                logger(`Unix socket unavailable (${err.message}), falling back to WASM`);
                const backend = await (0, index_js_3.createAsyncBackend)(index_js_2.BackendType.Wasm, options, logger);
                await backend.initSRSChonk();
                return backend;
            }
        }
        else {
            logger(`In browser, using WASM over worker backend.`);
            const backend = await (0, index_js_3.createAsyncBackend)(index_js_2.BackendType.WasmWorker, options, logger);
            await backend.initSRSChonk();
            return backend;
        }
    }
    async initSRSChonk(srsSize = this.getDefaultSrsSize()) {
        // crsPath can be undefined
        const crs = await index_js_1.Crs.new(srsSize + 1, this.options.crsPath, this.options.logger);
        const grumpkinCrs = await index_js_1.GrumpkinCrs.new(2 ** 16 + 1, this.options.crsPath, this.options.logger);
        // Load CRS into wasm global CRS state.
        // TODO: Make RawBuffer be default behavior, and have a specific Vector type for when wanting length prefixed.
        await this.srsInitSrs({ pointsBuf: crs.getG1Data(), numPoints: crs.numPoints, g2Point: crs.getG2Data() });
        await this.srsInitGrumpkinSrs({ pointsBuf: grumpkinCrs.getG1Data(), numPoints: grumpkinCrs.numPoints });
    }
    getDefaultSrsSize() {
        // iOS browser is very aggressive with memory. Check if running in browser and on iOS.
        // We expect the mobile iOS browser to kill us >=1GB, so no real use in using a larger SRS.
        // Use `self` instead of `window` so this check also works inside Web Workers.
        if (typeof self !== 'undefined' && typeof self.navigator !== 'undefined' && /iPad|iPhone/.test(self.navigator.userAgent)) {
            return 2 ** 18;
        }
        return 2 ** 20;
    }
    async acirGetCircuitSizes(bytecode, recursive, honkRecursion) {
        const response = await this.circuitStats({
            circuit: { name: '', bytecode, verificationKey: new Uint8Array() },
            includeGatesPerOpcode: false,
            settings: {
                ipaAccumulation: false,
                oracleHashType: honkRecursion ? 'poseidon2' : 'keccak',
                disableZk: !recursive,
                optimizedSolidityVerifier: false,
            },
        });
        return [response.numGates, response.numGatesDyadic];
    }
    async destroy() {
        return super.destroy();
    }
    /**
     * Initialize the singleton instance of Barretenberg.
     * @param options Backend configuration options
     */
    static async initSingleton(options = {}) {
        if (!barretenbergSingletonPromise) {
            barretenbergSingletonPromise = Barretenberg.new(options);
        }
        try {
            barretenbergSingleton = await barretenbergSingletonPromise;
            return barretenbergSingleton;
        }
        catch (error) {
            // If initialization fails, clear the singleton so next call can retry
            barretenbergSingleton = undefined;
            barretenbergSingletonPromise = undefined;
            throw error;
        }
    }
    static async destroySingleton() {
        if (barretenbergSingleton) {
            await barretenbergSingleton.destroy();
            barretenbergSingleton = undefined;
            barretenbergSingletonPromise = undefined;
        }
    }
    /**
     * Get the singleton instance of Barretenberg.
     * Must call initSingleton() first.
     */
    static getSingleton() {
        if (!barretenbergSingleton) {
            throw new Error('First call Barretenberg.initSingleton() on @aztec/bb.js module.');
        }
        return barretenbergSingleton;
    }
}
exports.Barretenberg = Barretenberg;
let barretenbergSingletonPromise;
let barretenbergSingleton;
let barretenbergSyncSingletonPromise;
let barretenbergSyncSingleton;
class BarretenbergSync extends sync_js_1.SyncApi {
    constructor(backend) {
        super(backend);
    }
    /**
     * Create a new BarretenbergSync instance.
     *
     * If options.backend is set: uses that specific backend (throws if unavailable)
     * If options.backend is unset: tries backends in order with fallback:
     *   1. NativeSharedMem (if bb binary + NAPI module available)
     *   2. Wasm
     *
     * Supported backends: Wasm, NativeSharedMem
     * Not supported: WasmWorker (no workers in sync), NativeUnixSocket (async only)
     */
    static async new(options = {}) {
        const logger = options.logger ?? (() => { });
        if (options.backend) {
            return await (0, index_js_3.createSyncBackend)(options.backend, options, logger);
        }
        // Try native, fallback to WASM.
        try {
            return await (0, index_js_3.createSyncBackend)(index_js_2.BackendType.NativeSharedMemory, options, logger);
        }
        catch (err) {
            logger(`Shared memory unavailable (${err.message}), falling back to WASM`);
        }
        return await (0, index_js_3.createSyncBackend)(index_js_2.BackendType.Wasm, options, logger);
    }
    /**
     * Initialize the singleton instance.
     * @param options Backend configuration options
     */
    static async initSingleton(options = {}) {
        if (!barretenbergSyncSingletonPromise) {
            barretenbergSyncSingletonPromise = BarretenbergSync.new(options);
        }
        barretenbergSyncSingleton = await barretenbergSyncSingletonPromise;
        return barretenbergSyncSingleton;
    }
    static destroySingleton() {
        if (barretenbergSyncSingleton) {
            barretenbergSyncSingleton.destroy();
            barretenbergSyncSingleton = undefined;
            barretenbergSyncSingletonPromise = undefined;
        }
    }
    static getSingleton() {
        if (!barretenbergSyncSingleton) {
            throw new Error('First call BarretenbergSync.initSingleton() on @aztec/bb.js module.');
        }
        return barretenbergSyncSingleton;
    }
}
exports.BarretenbergSync = BarretenbergSync;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYmFycmV0ZW5iZXJnL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSw4Q0FBbUQ7QUFDbkQsMERBQXVEO0FBQ3ZELHdEQUFxRDtBQUVyRCxzREFBc0U7QUFDdEUsMkRBQXFGO0FBRXJGLDZDQVFzQjtBQVBwQiw4R0FBQSxnQkFBZ0IsT0FBQTtBQUNoQixzSEFBQSx3QkFBd0IsT0FBQTtBQUN4QixnSEFBQSxrQkFBa0IsT0FBQTtBQUNsQiwyR0FBQSxhQUFhLE9BQUE7QUFDYiw2R0FBQSxlQUFlLE9BQUE7QUFJakIsa0VBQXdDO0FBT3hDOzs7R0FHRztBQUNILGtCQUEwQixTQUFRLG1CQUFRO0lBQ2hDLE9BQU8sQ0FBaUI7SUFFaEMsWUFBWSxPQUE2QixFQUFFLE9BQXVCLEVBQUU7UUFDbEUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2YsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFBQSxDQUN4QjtJQUVEOzs7Ozs7O09BT0c7SUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEdBQW1CLEVBQUUsRUFBRTtRQUM3QyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBQyxDQUFDLENBQUMsQ0FBQztRQUU1QyxJQUFJLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNwQiwwQ0FBMEM7WUFDMUMsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFBLDZCQUFrQixFQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQzNFLElBQUksT0FBTyxDQUFDLE9BQU8sS0FBSyxzQkFBVyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsT0FBTyxLQUFLLHNCQUFXLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBQ3ZGLE1BQU0sT0FBTyxDQUFD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