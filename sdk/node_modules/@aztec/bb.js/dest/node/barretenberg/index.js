import { Crs, GrumpkinCrs } from '../crs/index.js';
import { AsyncApi } from '../cbind/generated/async.js';
import { SyncApi } from '../cbind/generated/sync.js';
import { BackendType } from '../bb_backends/index.js';
import { createAsyncBackend, createSyncBackend } from '../bb_backends/node/index.js';
export { UltraHonkBackend, UltraHonkVerifierBackend, AztecClientBackend, fieldToString, fieldsToStrings, } from './backend.js';
export * from '../bb_backends/index.js';
/**
 * The main class library consumers interact with.
 * It extends the generated api, and provides a static constructor "new" to compose components.
 */
export class Barretenberg extends AsyncApi {
    options;
    constructor(backend, options) {
        super(backend);
        this.options = options;
    }
    /**
     * Constructs an instance of Barretenberg.
     *
     * If options.backend is set: uses that specific backend (throws if unavailable)
     * If options.backend is unset: tries backends in order with fallback:
     *   1. NativeUnixSocket (if bb binary available)
     *   2. WasmWorker (in browser) or Wasm (in Node.js)
     */
    static async new(options = {}) {
        const logger = options.logger ?? (() => { });
        if (options.backend) {
            // Explicit backend required - no fallback
            const backend = await createAsyncBackend(options.backend, options, logger);
            if (options.backend === BackendType.Wasm || options.backend === BackendType.WasmWorker) {
                await backend.initSRSChonk();
            }
            return backend;
        }
        if (typeof window === 'undefined') {
            try {
                return await createAsyncBackend(BackendType.NativeUnixSocket, options, logger);
            }
            catch (err) {
                logger(`Unix socket unavailable (${err.message}), falling back to WASM`);
                const backend = await createAsyncBackend(BackendType.Wasm, options, logger);
                await backend.initSRSChonk();
                return backend;
            }
        }
        else {
            logger(`In browser, using WASM over worker backend.`);
            const backend = await createAsyncBackend(BackendType.WasmWorker, options, logger);
            await backend.initSRSChonk();
            return backend;
        }
    }
    async initSRSChonk(srsSize = this.getDefaultSrsSize()) {
        // crsPath can be undefined
        const crs = await Crs.new(srsSize + 1, this.options.crsPath, this.options.logger);
        const grumpkinCrs = await GrumpkinCrs.new(2 ** 16 + 1, this.options.crsPath, this.options.logger);
        // Load CRS into wasm global CRS state.
        // TODO: Make RawBuffer be default behavior, and have a specific Vector type for when wanting length prefixed.
        await this.srsInitSrs({ pointsBuf: crs.getG1Data(), numPoints: crs.numPoints, g2Point: crs.getG2Data() });
        await this.srsInitGrumpkinSrs({ pointsBuf: grumpkinCrs.getG1Data(), numPoints: grumpkinCrs.numPoints });
    }
    getDefaultSrsSize() {
        // iOS browser is very aggressive with memory. Check if running in browser and on iOS.
        // We expect the mobile iOS browser to kill us >=1GB, so no real use in using a larger SRS.
        // Use `self` instead of `window` so this check also works inside Web Workers.
        if (typeof self !== 'undefined' && typeof self.navigator !== 'undefined' && /iPad|iPhone/.test(self.navigator.userAgent)) {
            return 2 ** 18;
        }
        return 2 ** 20;
    }
    async acirGetCircuitSizes(bytecode, recursive, honkRecursion) {
        const response = await this.circuitStats({
            circuit: { name: '', bytecode, verificationKey: new Uint8Array() },
            includeGatesPerOpcode: false,
            settings: {
                ipaAccumulation: false,
                oracleHashType: honkRecursion ? 'poseidon2' : 'keccak',
                disableZk: !recursive,
                optimizedSolidityVerifier: false,
            },
        });
        return [response.numGates, response.numGatesDyadic];
    }
    async destroy() {
        return super.destroy();
    }
    /**
     * Initialize the singleton instance of Barretenberg.
     * @param options Backend configuration options
     */
    static async initSingleton(options = {}) {
        if (!barretenbergSingletonPromise) {
            barretenbergSingletonPromise = Barretenberg.new(options);
        }
        try {
            barretenbergSingleton = await barretenbergSingletonPromise;
            return barretenbergSingleton;
        }
        catch (error) {
            // If initialization fails, clear the singleton so next call can retry
            barretenbergSingleton = undefined;
            barretenbergSingletonPromise = undefined;
            throw error;
        }
    }
    static async destroySingleton() {
        if (barretenbergSingleton) {
            await barretenbergSingleton.destroy();
            barretenbergSingleton = undefined;
            barretenbergSingletonPromise = undefined;
        }
    }
    /**
     * Get the singleton instance of Barretenberg.
     * Must call initSingleton() first.
     */
    static getSingleton() {
        if (!barretenbergSingleton) {
            throw new Error('First call Barretenberg.initSingleton() on @aztec/bb.js module.');
        }
        return barretenbergSingleton;
    }
}
let barretenbergSingletonPromise;
let barretenbergSingleton;
let barretenbergSyncSingletonPromise;
let barretenbergSyncSingleton;
export class BarretenbergSync extends SyncApi {
    constructor(backend) {
        super(backend);
    }
    /**
     * Create a new BarretenbergSync instance.
     *
     * If options.backend is set: uses that specific backend (throws if unavailable)
     * If options.backend is unset: tries backends in order with fallback:
     *   1. NativeSharedMem (if bb binary + NAPI module available)
     *   2. Wasm
     *
     * Supported backends: Wasm, NativeSharedMem
     * Not supported: WasmWorker (no workers in sync), NativeUnixSocket (async only)
     */
    static async new(options = {}) {
        const logger = options.logger ?? (() => { });
        if (options.backend) {
            return await createSyncBackend(options.backend, options, logger);
        }
        // Try native, fallback to WASM.
        try {
            return await createSyncBackend(BackendType.NativeSharedMemory, options, logger);
        }
        catch (err) {
            logger(`Shared memory unavailable (${err.message}), falling back to WASM`);
        }
        return await createSyncBackend(BackendType.Wasm, options, logger);
    }
    /**
     * Initialize the singleton instance.
     * @param options Backend configuration options
     */
    static async initSingleton(options = {}) {
        if (!barretenbergSyncSingletonPromise) {
            barretenbergSyncSingletonPromise = BarretenbergSync.new(options);
        }
        barretenbergSyncSingleton = await barretenbergSyncSingletonPromise;
        return barretenbergSyncSingleton;
    }
    static destroySingleton() {
        if (barretenbergSyncSingleton) {
            barretenbergSyncSingleton.destroy();
            barretenbergSyncSingleton = undefined;
            barretenbergSyncSingletonPromise = undefined;
        }
    }
    static getSingleton() {
        if (!barretenbergSyncSingleton) {
            throw new Error('First call BarretenbergSync.initSingleton() on @aztec/bb.js module.');
        }
        return barretenbergSyncSingleton;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYmFycmV0ZW5iZXJnL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUVyRCxPQUFPLEVBQWtCLFdBQVcsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRXJGLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsd0JBQXdCLEVBQ3hCLGtCQUFrQixFQUNsQixhQUFhLEVBQ2IsZUFBZSxHQUdoQixNQUFNLGNBQWMsQ0FBQztBQUN0QixjQUFjLHlCQUF5QixDQUFDO0FBT3hDOzs7R0FHRztBQUNILE1BQU0sT0FBTyxZQUFhLFNBQVEsUUFBUTtJQUNoQyxPQUFPLENBQWlCO0lBRWhDLFlBQVksT0FBNkIsRUFBRSxPQUF1QixFQUFFO1FBQ2xFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNmLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQUEsQ0FDeEI7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxHQUFtQixFQUFFLEVBQUU7UUFDN0MsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUMsQ0FBQyxDQUFDLENBQUM7UUFFNUMsSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDcEIsMENBQTBDO1lBQzFDLE1BQU0sT0FBTyxHQUFHLE1BQU0sa0JBQWtCLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFB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