import * as path from 'path';
import * as fs from 'fs';
import { fileURLToPath } from 'url';
function getCurrentDir() {
    if (typeof __dirname !== 'undefined') {
        return __dirname;
    }
    else {
        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
        // @ts-ignore
        return path.dirname(fileURLToPath(import.meta.url));
    }
}
/**
 * Find package root by climbing directory tree until package.json is found.
 * @param startDir Starting directory to search from
 * @returns Absolute path to package root, or null if not found
 */
export function findPackageRoot() {
    let currentDir = getCurrentDir();
    const root = path.parse(currentDir).root;
    while (currentDir !== root) {
        const packageJsonPath = path.join(currentDir, 'package.json');
        if (fs.existsSync(packageJsonPath)) {
            // Check if this is the actual package root by verifying it has a 'build' directory
            // This ensures we skip intermediate package.json files (e.g., in dest/node-cjs/)
            const buildDir = path.join(currentDir, 'build');
            if (fs.existsSync(buildDir)) {
                return currentDir;
            }
        }
        currentDir = path.dirname(currentDir);
    }
    return null;
}
/**
 * Map from Platform to build directory name.
 */
const PLATFORM_TO_BUILD_DIR = {
    'x86_64-linux': 'amd64-linux',
    'x86_64-darwin': 'amd64-macos',
    'aarch64-linux': 'arm64-linux',
    'aarch64-darwin': 'arm64-macos',
};
/**
 * Detect the current platform and architecture.
 * @returns Platform identifier or null if unsupported
 */
export function detectPlatform() {
    const arch = process.arch; // 'x64' | 'arm64' | ...
    const platform = process.platform; // 'linux' | 'darwin' | 'win32' | ...
    if (arch === 'x64' && platform === 'linux') {
        return 'x86_64-linux';
    }
    if (arch === 'x64' && platform === 'darwin') {
        return 'x86_64-darwin';
    }
    if (arch === 'arm64' && platform === 'linux') {
        return 'aarch64-linux';
    }
    if (arch === 'arm64' && platform === 'darwin') {
        return 'aarch64-darwin';
    }
    return null;
}
/**
 * Find the bb binary for the native backend.
 * @param customPath Optional custom path to bb binary (overrides automatic detection)
 * @returns Absolute path to bb binary, or null if not found
 *
 * Search order:
 * 1. If customPath is provided and exists, return it
 * 2. Otherwise search in <package-root>/build/<platform>/bb
 */
export function findBbBinary(customPath) {
    // Check custom path first if provided
    if (customPath) {
        if (fs.existsSync(customPath)) {
            return path.resolve(customPath);
        }
        // Custom path provided but doesn't exist - return null
        return null;
    }
    // Automatic detection
    const platform = detectPlatform();
    if (!platform) {
        return null;
    }
    const buildDir = PLATFORM_TO_BUILD_DIR[platform];
    // Get package root by climbing directory tree to find package.json
    const packageRoot = findPackageRoot();
    if (!packageRoot) {
        return null;
    }
    // Check in build/<platform>/bb
    const bbPath = path.join(packageRoot, 'build', buildDir, 'bb');
    if (fs.existsSync(bbPath)) {
        return bbPath;
    }
    return null;
}
export function findNapiBinary(customPath) {
    // Check custom path first if provided
    if (customPath) {
        if (fs.existsSync(customPath)) {
            return path.resolve(customPath);
        }
        // Custom path provided but doesn't exist - return null
        return null;
    }
    // Automatic detection
    const platform = detectPlatform();
    if (!platform) {
        return null;
    }
    const buildDir = PLATFORM_TO_BUILD_DIR[platform];
    // Get package root by climbing directory tree to find package.json
    const packageRoot = findPackageRoot();
    if (!packageRoot) {
        return null;
    }
    // Check in build/<platform>/nodejs_module.node
    const bbPath = path.join(packageRoot, 'build', buildDir, 'nodejs_module.node');
    if (fs.existsSync(bbPath)) {
        return bbPath;
    }
    return null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxhdGZvcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYmJfYmFja2VuZHMvbm9kZS9wbGF0Zm9ybS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBRXBDLFNBQVMsYUFBYSxHQUFHO0lBQ3ZCLElBQUksT0FBTyxTQUFTLEtBQUssV0FBVyxFQUFFLENBQUM7UUFDckMsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztTQUFNLENBQUM7UUFDTiw2REFBNkQ7UUFDN0QsYUFBYTtRQUNiLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0FBQUEsQ0FDRjtBQUVEOzs7O0dBSUc7QUFDSCxNQUFNLFVBQVUsZUFBZSxHQUFrQjtJQUMvQyxJQUFJLFVBQVUsR0FBRyxhQUFhLEVBQUUsQ0FBQztJQUNqQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUV6QyxPQUFPLFVBQVUsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUMzQixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUM5RCxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQztZQUNuQyxtRkFBbUY7WUFDbkYsaUZBQWlGO1lBQ2pGLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2hELElBQUksRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRSxD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