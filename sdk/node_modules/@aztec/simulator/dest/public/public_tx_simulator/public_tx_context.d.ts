import { Fr } from '@aztec/foundation/curves/bn254';
import { type LoggerBindings } from '@aztec/foundation/log';
import { AvmCircuitPublicInputs, RevertCode } from '@aztec/stdlib/avm';
import type { AztecAddress } from '@aztec/stdlib/aztec-address';
import { type ContractDeploymentData } from '@aztec/stdlib/contract';
import type { SimulationError } from '@aztec/stdlib/errors';
import { Gas } from '@aztec/stdlib/gas';
import { PrivateToPublicAccumulatedData } from '@aztec/stdlib/kernel';
import { type GlobalVariables, ProtocolContracts, PublicCallRequestWithCalldata, type Tx, TxExecutionPhase, type TxHash } from '@aztec/stdlib/tx';
import type { PublicContractsDBInterface } from '../db_interfaces.js';
import type { PublicTreesDB } from '../public_db_sources.js';
import { PublicPersistableStateManager } from '../state_manager/state_manager.js';
/**
 * The transaction-level context for public execution.
 */
export declare class PublicTxContext {
    readonly txHash: TxHash;
    readonly state: PhaseStateManager;
    private readonly startTreeSnapshots;
    private readonly globalVariables;
    private readonly protocolContracts;
    private readonly proverId;
    private readonly gasSettings;
    private readonly gasUsedByPrivate;
    private readonly gasAllocatedToPublic;
    private readonly gasAllocatedToPublicTeardown;
    private readonly setupCallRequests;
    private readonly appLogicCallRequests;
    private readonly teardownCallRequests;
    readonly nonRevertibleContractDeploymentData: ContractDeploymentData;
    readonly revertibleContractDeploymentData: ContractDeploymentData;
    readonly nonRevertibleAccumulatedDataFromPrivate: PrivateToPublicAccumulatedData;
    readonly revertibleAccumulatedDataFromPrivate: PrivateToPublicAccumulatedData;
    readonly feePayer: AztecAddress;
    private readonly trace;
    private log;
    private gasUsedByPublic;
    teardownGasUsed: Gas;
    private halted;
    private revertCode;
    revertReason: SimulationError | undefined;
    private constructor();
    static create(treesDB: PublicTreesDB, contractsDB: PublicContractsDBInterface, tx: Tx, globalVariables: GlobalVariables, protocolContracts: ProtocolContracts, proverId: Fr, bindings?: LoggerBindings): Promise<PublicTxContext>;
    /**
     * Signal that the entire transaction execution is done.
     * All phases have been processed.
     * Actual transaction fee and actual total consumed gas can now be queried.
     */
    halt(): void;
    /**
     * Revert execution a phase. Populate revertReason & revertCode.
     * If in setup, throw an error (transaction will be thrown out).
     * NOTE: this does not "halt" the entire transaction execution.
     */
    revert(phase: TxExecutionPhase, revertReason?: SimulationError | undefined, culprit?: string): void;
    /**
     * Get the revert code.
     * @returns The revert code.
     */
    getFinalRevertCode(): RevertCode;
    /**
     * Are there any call requests for the speciiied phase?
     */
    hasPhase(phase: TxExecutionPhase): boolean;
    /**
     * Get the call requests for the specified phase (including args hashes).
     */
    getCallRequestsForPhase(phase: TxExecutionPhase): PublicCallRequestWithCalldata[];
    /**
     * How much gas is left as of the specified phase?
     */
    getGasLeftAtPhase(phase: TxExecutionPhase): Gas;
    /**
     * Consume gas. Track gas for teardown phase separately.
     */
    consumeGas(phase: TxExecutionPhase, gas: Gas): void;
    /**
     * The gasUsed by public and private,
     * as if the entire teardown gas limit was consumed.
     */
    getTotalGasUsed(): Gas;
    /**
     * Compute the gas used using the actual gas used during teardown instead
     * of the teardown gas limit.
     * Note that this.gasUsed is initialized from private's gasUsed which includes
     * teardown gas limit.
     */
    getActualGasUsed(): Gas;
    /**
     * Compute the public gas used using the actual gas used during teardown instead
     * of the teardown gas limit.
     */
    getActualPublicGasUsed(): Gas;
    /**
     * Get the transaction fee as is available to the specified phase.
     * Only teardown should have access to the actual transaction fee.
     */
    getTransactionFee(phase: TxExecutionPhase): Fr;
    /**
     * Compute the transaction fee.
     * Should only be called during or after teardown.
     */
    private getTransactionFeeUnsafe;
    /**
     * Generate the public inputs for the AVM circuit.
     */
    generateAvmCircuitPublicInputs(): Promise<AvmCircuitPublicInputs>;
}
/**
 * Thin wrapper around the state manager to handle forking and merging for phases.
 *
 * This lets us keep track of whether the state has already been forked
 * so that we can conditionally fork at the start of a phase.
 *
 * There is a state manager that lives at the level of the entire transaction,
 * but for app logic and teardown the active state manager will be a fork of the
 * transaction level one.
 */
declare class PhaseStateManager {
    private readonly txStateManager;
    private log;
    private currentlyActiveStateManager;
    constructor(txStateManager: PublicPersistableStateManager, bindings?: LoggerBindings);
    fork(): Promise<void>;
    getActiveStateManager(): PublicPersistableStateManager;
    isForked(): boolean;
    mergeForkedState(): Promise<void>;
    discardForkedState(): Promise<void>;
}
export {};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVibGljX3R4X2NvbnRleHQuZC50cyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wdWJsaWMvcHVibGljX3R4X3NpbXVsYXRvci9wdWJsaWNfdHhfY29udGV4dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFRQSxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDcEQsT0FBTyxFQUFlLEtBQUssY0FBYyxFQUFnQixNQUFNLHVCQUF1QixDQUFDO0FBQ3ZGLE9BQU8sRUFHTCxzQkFBc0IsRUFFdEIsVUFBVSxFQUNYLE1BQU0sbUJBQW1CLENBQUM7QUFDM0IsT0FBTyxLQUFLLEVBQUUsWUFBWSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDaEUsT0FBTyxFQUE2QixLQUFLLHNCQUFzQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDaEcsT0FBTyxLQUFLLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFNUQsT0FBTyxFQUFFLEdBQUcsRUFBZSxNQUFNLG1CQUFtQixDQUFDO0FBQ3JELE9BQU8sRUFHTCw4QkFBOEIsRUFJL0IsTUFBTSxzQkFBc0IsQ0FBQztBQUk5QixPQUFPLEVBQ0wsS0FBSyxlQUFlLEVBQ3BCLGlCQUFpQixFQUNqQiw2QkFBNkIsRUFFN0IsS0FBSyxFQUFFLEVBQ1AsZ0JBQWdCLEVBQ2hCLEtBQUssTUFBTSxFQUNaLE1BQU0sa0JBQWtCLENBQUM7QUFLMUIsT0FBTyxLQUFLLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RSxPQUFPLEtBQUssRUFBRSxhQUFhLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU3RCxPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUdsRjs7R0FFRztBQUNILHFCQUFhLGVBQWU7YUFlUixNQUFNLEVBQUUsTUFBTTthQUNkLEtBQUssRUFBRSxpQkFBaUI7SUFDeEMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxr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