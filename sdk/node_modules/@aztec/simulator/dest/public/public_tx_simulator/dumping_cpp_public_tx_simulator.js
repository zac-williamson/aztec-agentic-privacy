import { AvmCircuitInputs, AvmCircuitPublicInputs, AvmExecutionHints, serializeWithMessagePack } from '@aztec/stdlib/avm';
import { strict as assert } from 'assert';
import { mkdirSync, writeFileSync } from 'fs';
import { join } from 'path';
import { CppPublicTxSimulator } from './cpp_public_tx_simulator.js';
/**
 * A C++ public tx simulator that dumps AVM circuit inputs to disk after simulation.
 * Used during nightly CI runs to collect circuit inputs for benchmarking.
 */ export class DumpingCppPublicTxSimulator extends CppPublicTxSimulator {
    outputDir;
    constructor(merkleTree, contractsDB, globalVariables, config, outputDir, bindings){
        super(merkleTree, contractsDB, globalVariables, config, bindings);
        assert(config.collectHints === true, 'collectHints must be enabled to dump AVM circuit inputs');
        assert(config.collectPublicInputs === true, 'collectPublicInputs must be enabled to dump AVM circuit inputs');
        this.outputDir = outputDir;
    }
    async simulate(tx) {
        const result = await super.simulate(tx);
        // Dump the circuit inputs after successful simulation
        const txHash = this.computeTxHash(tx);
        this.dumpAvmCircuitInputs(result, txHash);
        return result;
    }
    /**
   * Dumps AVM circuit inputs to disk.
   *
   * @param result - The simulation result containing hints and public inputs
   * @param txHash - The transaction hash to use in the filename
   */ dumpAvmCircuitInputs(result, txHash) {
        try {
            // Ensure the output directory exists
            mkdirSync(this.outputDir, {
                recursive: true
            });
            // Generate filename using transaction hash
            const filename = `avm-circuit-inputs-tx-${txHash.toString()}.bin`;
            const filepath = join(this.outputDir, filename);
            // Create circuit inputs from the result
            const hints = result.hints ?? AvmExecutionHints.empty();
            const publicInputs = result.publicInputs ?? AvmCircuitPublicInputs.empty();
            const avmCircuitInputs = new AvmCircuitInputs(hints, publicInputs);
            // Serialize the circuit inputs using MessagePack
            const serialized = serializeWithMessagePack(avmCircuitInputs);
            // Write to disk
            writeFileSync(filepath, serialized);
            this.log.debug(`Dumped AVM circuit inputs to ${filepath}`);
        } catch (error) {
            // Non-blocking error handling - log but don't interrupt processing
            this.log.warn(`Failed to dump AVM circuit inputs for tx ${txHash.toString()}: ${error}`);
        }
    }
}
