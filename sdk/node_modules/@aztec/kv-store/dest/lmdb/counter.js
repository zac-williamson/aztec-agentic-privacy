import { LmdbAztecMap } from './map.js';
/**
 * A counter implementation backed by LMDB
 */ export class LmdbAztecCounter {
    #db;
    #name;
    #map;
    constructor(db, name){
        this.#db = db;
        this.#name = name;
        this.#map = new LmdbAztecMap(db, name);
    }
    async set(key, value) {
        await this.#map.set(key, value);
    }
    update(key, delta = 1) {
        return this.#db.childTransaction(()=>{
            const current = this.#map.get(key) ?? 0;
            const next = current + delta;
            if (next < 0) {
                throw new Error(`Cannot update ${key} in counter ${this.#name} below zero`);
            }
            if (next === 0) {
                void this.#map.delete(key);
            } else {
                // store the key inside the entry because LMDB might return an internal representation
                // of the key when iterating over the database
                void this.#map.set(key, next);
            }
        });
    }
    get(key) {
        return this.#map.get(key) ?? 0;
    }
    getAsync(key) {
        return Promise.resolve(this.get(key));
    }
    entries(range = {}) {
        return this.#map.entries(range);
    }
    async *entriesAsync(range = {}) {
        yield* this.entries(range);
    }
    keys(range = {}) {
        return this.#map.keys(range);
    }
    async *keysAsync(range = {}) {
        yield* this.keys(range);
    }
}
