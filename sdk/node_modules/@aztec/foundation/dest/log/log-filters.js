import { LogLevels } from './log-levels.js';
export function getLogLevelFromFilters(filters, module) {
    for (const [filterModule, level] of filters){
        try {
            const regex = new RegExp(filterModule);
            if (regex.test(module)) {
                return level;
            }
        } catch  {
            // If regex is invalid, fall back to startsWith check
            if (module.startsWith(filterModule)) {
                return level;
            }
        }
    }
    return undefined;
}
/**
 * Parses the LOG_LEVEL env string into a default level and per-module filter overrides.
 *
 * Format: `<default_level>;<level>:<module1>,<module2>;<level>:<module3>;...`
 * - First segment (before the first `;`) is the default log level for all modules.
 * - Remaining segments are `level:module` pairs: apply the given level to the listed modules (comma-separated).
 * - Later filters override earlier ones for overlapping module matches.
 * - The `aztec:` prefix is stripped from module names; spaces are trimmed.
 *
 * @example
 * ```ts
 * parseLogLevel('debug;warn:module1,module2;error:module3', 'info')
 * // => ['debug', [['module3', 'error'], ['module2', 'warn'], ['module1', 'warn']]]
 * ```
 */ export function parseLogLevelEnvVar(logLevelEnvVar, defaultLevel) {
    if (!logLevelEnvVar) {
        return [
            defaultLevel,
            []
        ];
    }
    const [level] = logLevelEnvVar.split(';', 1);
    assertValidLogLevel(level);
    return [
        level,
        parseFilters(logLevelEnvVar.slice(level.length + 1))
    ];
}
function assertValidLogLevel(level) {
    if (!LogLevels.includes(level)) {
        throw new Error(`Invalid log level: ${level}`);
    }
}
function parseFilters(definition) {
    if (!definition) {
        return [];
    }
    const statements = definition.split(';');
    const filters = [];
    for (const statement of statements){
        const [level] = statement.split(':', 1);
        const modules = statement.slice(level.length + 1);
        if (!modules || !level) {
            throw new Error(`Invalid log filter statement: ${statement}`);
        }
        const sanitizedLevel = level.trim().toLowerCase();
        assertValidLogLevel(sanitizedLevel);
        for (const module of modules.split(',')){
            filters.push([
                module.trim().toLowerCase().replace(/^aztec:/, ''),
                sanitizedLevel
            ]);
        }
    }
    return filters.reverse();
}
