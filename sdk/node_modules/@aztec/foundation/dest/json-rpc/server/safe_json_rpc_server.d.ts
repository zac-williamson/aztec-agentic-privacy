import http from 'http';
import { type default as Application } from 'koa';
import Router from 'koa-router';
import { type Logger } from '../../log/index.js';
import { type ApiSchemaFor } from '../../schemas/index.js';
export type DiagnosticsData = {
    id: number | string | null;
    method: string;
    params: any[];
    headers: http.IncomingHttpHeaders;
};
export type DiagnosticsMiddleware = (ctx: DiagnosticsData, next: () => Promise<void>) => Promise<void>;
export type SafeJsonRpcServerConfig = {
    /** Maximum batch size for batched rpc requests */
    maxBatchSize: number;
    /** Return an HTTP 200 status code on errors, but include an error object as per the JSON RPC spec */
    http200OnError: boolean;
    /** The maximum body size the server will accept */
    maxBodySizeBytes: string;
};
export declare class SafeJsonRpcServer {
    /** The proxy object to delegate requests to */
    private readonly proxy;
    /** Health check function */
    private readonly healthCheck;
    /** Additional middlewares */
    private extraMiddlewares;
    /** Logger */
    private log;
    /**
     * The HTTP server accepting remote requests.
     * This member field is initialized when the server is started.
     */
    private httpServer?;
    private config;
    constructor(
    /** The proxy object to delegate requests to */
    proxy: Proxy, config?: Partial<SafeJsonRpcServerConfig>, 
    /** Health check function */
    healthCheck?: StatusCheckFn, 
    /** Additional middlewares */
    extraMiddlewares?: Application.Middleware[], 
    /** Logger */
    log?: Logger);
    isHealthy(): boolean | Promise<boolean>;
    /**
     * Get an express app object.
     * @param prefix - Our server prefix.
     * @returns The app object.
     */
    getApp(prefix?: string): Application<Application.DefaultState, Application.DefaultContext>;
    /**
     * Get a router object wrapping our RPC class.
     * @param prefix - The server prefix.
     * @returns The router object.
     */
    private getRouter;
    private processBatch;
    private processRequest;
    /**
     * Start this server with koa.
     * @param port - Port number.
     * @param prefix - Prefix string.
     */
    start(port: number, prefix?: string): void;
    /**
     * Stops the HTTP server
     */
    stop(): Promise<void>;
    /**
     * Explicitly calls an RPC method.
     * @param methodName - The RPC method.
     * @param jsonParams - The RPC parameters.
     * @returns The remote result.
     */
    call(methodName: string, jsonParams?: any[]): Promise<any>;
}
export type StatusCheckFn = () => boolean | Promise<boolean>;
interface Proxy {
    hasMethod(methodName: string): boolean;
    call(methodName: string, jsonParams?: any[]): Promise<any>;
}
/**
 * Forwards calls to a handler. Relies on a schema definition to validate and convert inputs
 * before forwarding calls, and then converts outputs into JSON using default conversions.
 */
export declare class SafeJsonProxy<T extends object = any> implements Proxy {
    private handler;
    private log;
    private schema;
    constructor(handler: T, schema: ApiSchemaFor<T>);
    /**
     * Call an RPC method.
     * @param methodName - The RPC method.
     * @param jsonParams - The RPC parameters.
     * @returns The remote result.
     */
    call(methodName: string, jsonParams?: any[]): Promise<any>;
    hasMethod(methodName: string): boolean;
}
export type NamespacedApiHandlers = Record<string, ApiHandler>;
export type ApiHandler<T extends object = any> = [T, ApiSchemaFor<T>, StatusCheckFn?];
export declare function makeHandler<T extends object>(handler: T, schema: ApiSchemaFor<T>): ApiHandler<T>;
export type SafeJsonRpcServerOptions = Partial<SafeJsonRpcServerConfig & {
    healthCheck: StatusCheckFn;
    log: Logger;
    middlewares: Application.Middleware[];
}>;
/**
 * Creates a single SafeJsonRpcServer from multiple handlers.
 * @param servers - List of handlers to be combined.
 * @returns A single JsonRpcServer with namespaced methods.
 */
export declare function createNamespacedSafeJsonRpcServer(handlers: NamespacedApiHandlers, options?: Omit<SafeJsonRpcServerOptions, 'healthcheck'>): SafeJsonRpcServer;
export declare function createSafeJsonRpcServer<T extends object = any>(handler: T, schema: ApiSchemaFor<T>, options?: SafeJsonRpcServerOptions): SafeJsonRpcServer;
/**
 * Creates a router for handling a plain status request that will return 200 status when running.
 * @param getCurrentStatus - List of health check functions to run.
 * @param apiPrefix - The prefix to use for all api requests
 * @returns - The router for handling status requests.
 */
export declare function createStatusRouter(getCurrentStatus: StatusCheckFn, apiPrefix?: string): Router<any, {}>;
/**
 * Wraps a JsonRpcServer in a nodejs http server and starts it.
 * Installs a status router that calls to the isHealthy method to the server.
 * Returns once starts listening unless noWait is set.
 * @returns A running http server.
 */
export declare function startHttpRpcServer(rpcServer: Pick<SafeJsonRpcServer, 'getApp' | 'isHealthy'>, options?: {
    host?: string;
    port?: number | string;
    apiPrefix?: string;
    timeoutMs?: number;
    noWait?: boolean;
}): Promise<http.Server & {
    port: number;
}>;
export {};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FmZV9qc29uX3JwY19zZXJ2ZXIuZC50cyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9qc29uLXJwYy9zZXJ2ZXIvc2FmZV9qc29uX3JwY19zZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sRUFBRSxLQUFLLE9BQU8sSUFBSSxXQUFXLEVBQWtCLE1BQU0sS0FBSyxDQUFDO0FBR2xFLE9BQU8sTUFBTSxNQUFNLFlBQVksQ0FBQztBQUtoQyxPQUFPLEVBQUUsS0FBSyxNQUFNLEVBQWdCLE1BQU0sb0JBQW9CLENBQUM7QUFFL0QsT0FBTyxFQUFrQixLQUFLLFlBQVksRUFBdUMsTUFBTSx3QkFBd0IsQ0FBQztBQUloSCxNQUFNLE1BQU0sZUFBZSxHQUFHO0lBQzVCLEVBQUUsRUFBRSxNQUFNLEdBQUcsTUFBTSxHQUFHLElBQUksQ0FBQztJQUMzQixNQUFNLEVBQUUsTUFBTSxDQUFDO0lBQ2YsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDO0lBQ2QsT0FBTyxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQztDQUNuQyxDQUFDO0FBRUYsTUFBTSxNQUFNLHFCQUFxQixHQUFHLENBQUMsR0FBRyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsTUFBTSxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBRXZHLE1BQU0sTUFBTSx1QkFBdUIsR0FBRztJQUNwQyxrREFBa0Q7SUFDbEQsWUFBWSxFQUFFLE1BQU0sQ0FBQztJQUNyQixxR0FBcUc7SUFDckcsY0FBYyxFQUFFLE9BQU8sQ0FBQztJQUN4QixtREFBbUQ7SUFDbkQsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDO0NBQzFCLENBQUM7QUFRRixxQkFBYSxpQkFBaUI7SUFVMUIsK0NBQStDO0lBQy9DLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSztJQUV0Qiw0QkFBNEI7SUFD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