import type { BlockNumber, CheckpointNumber } from '@aztec/foundation/branded-types';
import type { Fr } from '@aztec/foundation/curves/bn254';
import type { LoggerBindings } from '@aztec/foundation/log';
import type { L2Block } from '../block/l2_block.js';
import type { ChainConfig, SequencerConfig } from '../config/chain-config.js';
import type { L1RollupConstants } from '../epoch-helpers/index.js';
import type { Gas } from '../gas/gas.js';
import type { BlockHeader } from '../tx/block_header.js';
import type { CheckpointGlobalVariables, GlobalVariables } from '../tx/global_variables.js';
import type { FailedTx, ProcessedTx } from '../tx/processed_tx.js';
import { Tx } from '../tx/tx.js';
import type { TxValidator } from '../tx/validator/tx_validator.js';
import type { MerkleTreeWriteOperations } from './merkle_tree_operations.js';
import type { ProcessedTxHandler } from './processed-tx-handler.js';
/** The interface to a block builder. Generates an L2 block out of a set of processed txs. */
export interface IBlockFactory extends ProcessedTxHandler {
    /**
     * Prepares to build a new block. Updates the L1 to L2 message tree.
     * @param globalVariables - The global variables for this block.
     * @param l1ToL2Messages - The set of L1 to L2 messages to be included in this block.
     */
    startNewBlock(globalVariables: GlobalVariables, l1ToL2Messages: Fr[]): Promise<void>;
    /**
     * Adds all processed txs to the block. Updates world state with the effects from this tx.
     * @param txs - The transactions to be added.
     */
    addTxs(txs: ProcessedTx[]): Promise<void>;
    /**
     * Assembles the block and updates the archive tree.
     */
    setBlockCompleted(expectedBlockHeader?: BlockHeader): Promise<L2Block>;
}
export interface PublicProcessorLimits {
    maxTransactions?: number;
    maxBlockSize?: number;
    maxBlockGas?: Gas;
    maxBlobFields?: number;
    deadline?: Date;
}
export interface PublicProcessorValidator {
    preprocessValidator?: TxValidator<Tx>;
    nullifierCache?: {
        addNullifiers: (nullifiers: Buffer[]) => void;
    };
}
export type FullNodeBlockBuilderConfig = Pick<L1RollupConstants, 'l1GenesisTime' | 'slotDuration'> & Pick<ChainConfig, 'l1ChainId' | 'rollupVersion'> & Pick<SequencerConfig, 'txPublicSetupAllowList' | 'fakeProcessingDelayPerTxMs' | 'fakeThrowAfterProcessingTxCount'>;
export declare const FullNodeBlockBuilderConfigKeys: (keyof FullNodeBlockBuilderConfig)[];
/** Thrown when no valid transactions are available to include in a block after processing, and this is not the first block in a checkpoint. */
export declare class NoValidTxsError extends Error {
    readonly failedTxs: FailedTx[];
    constructor(failedTxs: FailedTx[]);
}
/** Result of building a block within a checkpoint. */
export type BuildBlockInCheckpointResult = {
    block: L2Block;
    publicGas: Gas;
    publicProcessorDuration: number;
    numTxs: number;
    failedTxs: FailedTx[];
    usedTxs: Tx[];
    usedTxBlobFields: number;
};
/** Interface for building blocks within a checkpoint context. */
export interface ICheckpointBlockBuilder {
    buildBlock(pendingTxs: Iterable<Tx> | AsyncIterable<Tx>, blockNumber: BlockNumber, timestamp: bigint, opts: PublicProcessorLimits): Promise<BuildBlockInCheckpointResult>;
}
/** Interface for creating checkpoint builders. */
export interface ICheckpointsBuilder {
    getFork(blockNumber: BlockNumber): Promise<MerkleTreeWriteOperations>;
    startCheckpoint(checkpointNumber: CheckpointNumber, constants: CheckpointGlobalVariables, feeAssetPriceModifier: bigint, l1ToL2Messages: Fr[], previousCheckpointOutHashes: Fr[], fork: MerkleTreeWriteOperations, bindings?: LoggerBindings): Promise<ICheckpointBlockBuilder>;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmxvY2stYnVpbGRlci5kLnRzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2ludGVyZmFjZXMvYmxvY2stYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNyRixPQUFPLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUN6RCxPQUFPLEtBQUssRUFBRSxjQUFjLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUU1RCxPQUFPLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNwRCxPQUFPLEtBQUssRUFBRSxXQUFXLEVBQUUsZUFBZSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDOUUsT0FBTyxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNuRSxPQUFPLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxLQUFLLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDekQsT0FBTyxLQUFLLEVBQUUseUJBQXlCLEVBQUUsZUFBZSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDNUYsT0FBTyxLQUFLLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ25FLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDakMsT0FBTyxLQUFLLEVBQUUsV0FBVyxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDbkUsT0FBTyxLQUFLLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM3RSxPQUFPLEtBQUssRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRXBFLDZGQUE2RjtBQUM3RixNQUFNLFdBQVcsYUFBYyxTQUFRLGtCQUFrQjtJQUN2RDs7OztP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