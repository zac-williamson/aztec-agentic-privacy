import { EthAddress } from '@aztec/foundation/eth-address';
import { type Logger } from '@aztec/foundation/log';
import fs from 'fs/promises';
import { DatabaseVersion } from './database_version.js';
export type DatabaseVersionManagerFs = Pick<typeof fs, 'readFile' | 'writeFile' | 'rm' | 'mkdir'>;
export declare const DATABASE_VERSION_FILE_NAME = "db_version";
export type DatabaseVersionManagerOptions<T> = {
    schemaVersion: number;
    rollupAddress: EthAddress;
    dataDirectory: string;
    onOpen: (dataDir: string) => Promise<T>;
    onUpgrade?: (dataDir: string, currentVersion: number, latestVersion: number) => Promise<void>;
    fileSystem?: DatabaseVersionManagerFs;
    log?: Logger;
};
/**
 * A manager for handling database versioning and migrations.
 * This class will check the version of data in a directory and either
 * reset or upgrade based on version compatibility.
 */
export declare class DatabaseVersionManager<T> {
    static readonly VERSION_FILE = "db_version";
    private readonly versionFile;
    private readonly currentVersion;
    private dataDirectory;
    private onOpen;
    private onUpgrade?;
    private fileSystem;
    private log;
    /**
     * Create a new version manager
     *
     * @param schemaVersion - The current version of the application
     * @param rollupAddress - The rollup contract address
     * @param dataDirectory - The directory where version information will be stored
     * @param onOpen - A callback to the open the database at the given location
     * @param onUpgrade - An optional callback to upgrade the database before opening. If not provided it will reset the database
     * @param fileSystem - An interface to access the filesystem
     * @param log - Optional custom logger
     * @param options - Configuration options
     */
    constructor({ schemaVersion, rollupAddress, dataDirectory, onOpen, onUpgrade, fileSystem, log }: DatabaseVersionManagerOptions<T>);
    static writeVersion(version: DatabaseVersion, dataDir: string, fileSystem?: DatabaseVersionManagerFs): Promise<void>;
    /**
     * Checks the stored version against the current version and handles the outcome
     * by either resetting the data directory or calling an upgrade function
     *
     * @param onReset - Function to call when a full reset is needed
     * @param onUpgrade - Function to call when an upgrade is needed
     * @returns True if data was reset, false if upgraded or no change needed
     */
    open(): Promise<[T, boolean]>;
    /**
     * Writes the current version to the version file
     */
    writeVersion(dir?: string): Promise<void>;
    /**
     * Resets the data directory by deleting it and recreating it
     */
    resetDataDirectory(): Promise<void>;
    /**
     * Get the data directory path
     */
    getDataDirectory(): string;
    /**
     * Get the current version number
     */
    getSchemaVersion(): number;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVyc2lvbl9tYW5hZ2VyLmQudHMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZGF0YWJhc2UtdmVyc2lvbi92ZXJzaW9uX21hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQzNELE9BQU8sRUFBRSxLQUFLLE1BQU0sRUFBZ0IsTUFBTSx1QkFBdUIsQ0FBQztBQUVsRSxPQUFPLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFHN0IsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXhELE1BQU0sTUFBTSx3QkFBd0IsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUUsVUFBVSxHQUFHLFdBQVcsR0FBRyxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUM7QUFFbEcsZUFBTyxNQUFNLDBCQUEwQixlQUFlLENBQUM7QUFFdkQsTUFBTSxNQUFNLDZCQUE2QixDQUFDLENBQUMsSUFBSTtJQUM3QyxhQUFhLEVBQUUsTUFBTSxDQUFDO0lBQ3RCLGFBQWEsRUFBRSxVQUFVLENBQUM7SUFDMUIsYUFBYSxFQUFFLE1BQU0sQ0FBQztJQUN0QixNQUFNLEVBQUUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN4QyxTQUFTLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsTUFBTSxLQUFLLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM5RixVQUFVLENBQUMsRUFBRSx3QkFBd0IsQ0FBQztJQUN0QyxHQUFHLENBQUMsRUFBRSxNQUFNLENBQUM7Q0FDZCxDQUFDO0FBRUY7Ozs7R0FJRztBQUNILHFCQUFhLHNCQUFzQixDQUFDLENBQUM7SUFDbkMsZ0JBQXVCLFlBQVksZ0JBQThCO0lBRWpFLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFTO0lBQ3JDLE9BQU8sQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFrQjtJQUVqRCxPQUFPLENBQUMsYUFBYSxDQUFTO0lBQzlCLE9BQU8sQ0FBQyxNQUFNLENBQWtDO0lBQ2hELE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBb0Y7SUFDdEcsT0FBTyxDQUFDLFVBQVUsQ0FBMkI7SUFDN0MsT0FBTyxDQUFDLEdBQUcsQ0FBUztJQUVwQjs7Ozs7Ozs7Ozs7T0FXRztJQUNILFlBQVksRUFDVixhQUFhLEVBQ2IsYUFBYSxFQUNiLGFBQWEsRUFDYixNQUFNLEVBQ04sU0FBUyxFQUNULFVBQWUsRUFDZixHQUFnRCxFQUNqRCxFQUFFLDZCQUE2QixDQUFDLENBQUMsQ0FBQyxFQWFsQztJQUVELE9BQWEsWUFBWSxDQUFDLE9BQU8sRUFBRSxlQUFlLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEdBQUUsd0JBQTZCLGlCQUc3RztJQUVEOzs7Ozs7O09BT0c7SUFDVSxJQUFJLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBNkR6QztJQUVEOztPQUVHO0lBQ0ksWUFBWSxDQUFDLEdBQUcsQ0FBQyxFQUFFLE1BQU0sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBRS9DO0lBRUQ7O09BRUc7SUFDVSxrQkFBa0IsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLENBUS9DO0lBRUQ7O09BRUc7SUFDSSxnQkFBZ0IsSUFBSSxNQUFNLENBRWhDO0lBRUQ7O09BRUc7SUFDSSxnQkFBZ0IsSUFBSSxNQUFNLENBRWhDO0NBQ0YifQ==