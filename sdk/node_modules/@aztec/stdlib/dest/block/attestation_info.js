import { recoverAddress } from '@aztec/foundation/crypto/secp256k1-signer';
import { ConsensusPayload } from '../p2p/consensus_payload.js';
import { SignatureDomainSeparator, getHashedSignaturePayloadEthSignedMessage } from '../p2p/signature_utils.js';
/**
 * Extracts attestation information from a published checkpoint.
 * Returns info for each attestation, preserving array indices.
 */ export function getAttestationInfoFromPublishedCheckpoint(block) {
    const payload = ConsensusPayload.fromCheckpoint(block.checkpoint);
    return getAttestationInfoFromPayload(payload, block.attestations);
}
export function getAttestationInfoFromPayload(payload, attestations) {
    const hashedPayload = getHashedSignaturePayloadEthSignedMessage(payload, SignatureDomainSeparator.checkpointAttestation);
    return attestations.map((attestation)=>{
        // If signature is empty, check if we have an address directly
        if (attestation.signature.isEmpty()) {
            if (attestation.address.isZero()) {
                // No signature and no address - empty
                return {
                    status: 'empty'
                };
            }
            // Address provided without signature
            return {
                address: attestation.address,
                status: 'provided-as-address'
            };
        }
        // Try to recover address from signature
        try {
            const recoveredAddress = recoverAddress(hashedPayload, attestation.signature);
            return {
                address: recoveredAddress,
                status: 'recovered-from-signature'
            };
        } catch  {
            // Signature present but recovery failed
            return {
                status: 'invalid-signature'
            };
        }
    });
}
